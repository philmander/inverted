<?xml version="1.0" encoding="utf-8"?>
<project name="Inverted" default="daily-build" basedir="." xmlns:ca="antlib:net.sourceforge.clearantlib">

	<!-- build dirs -->
	<property name="build.dir" value="${basedir}/build" />

	<!-- src dirs -->
	<property name="src.dir" value="${basedir}/src/main/inverted" />
	<property name="test.dir" value="${basedir}/src/test" />
	
	<!-- other dirs -->
	<property name="temp.dir" value="${basedir}/build/temp" />
	<property name="archive.dir" value="${basedir}/archive" />
	<property name="latest.dir" value="${basedir}/latest" />
	<property name="version.file" value="${basedir}/version.properties" />
	
	<taskdef name="jscomp" classname="com.google.javascript.jscomp.ant.CompileTask" classpath="${basedir}/ant/compiler.jar" />
	
	<target name="clean">
		<echo>Doing clean...for ${build.dir}</echo>
		<delete includeemptydirs="true">
			<fileset dir="${build.dir}" includes="**/*" />
		</delete>
		<mkdir dir="${build.dir}/"/>
		<echo>Doing clean... DONE</echo>
	</target>

	<target name="minify-javascript" depends="clean">
		<echo>Minifying Javascript... </echo>
		
		<copy todir="${build.dir}/">
			<fileset dir="${src.dir}" />
		</copy>
		
		<!-- uncompressed -->
		<concat destfile="${build.dir}/inverted.js" fixlastline="yes">
			<filelist dir="${build.dir}">
				<file name="release/intro.txt" />
				<file name="release/init.js" />				
				<file name="Util.js" />
				<file name="WebRequire.js" />
				<file name="CommonRequire.js" />
				<file name="resolvers/resolvers.js" />	
				<file name="ProtoFactory.js" />
				<file name="AppContext.js" />
				<file name="release/expose.js" />
				<file name="release/outro.txt" />
			</filelist>
		</concat>
		
		<!-- strip out debugs -->
		<copy file="${build.dir}/inverted.js" tofile="${build.dir}/inverted-min.js" />
		<replaceregexp file="${build.dir}/inverted-min.js" flags="g"
		               match="if\(DEBUG[^}]*}" replace=""/>
		
		<!-- compressed -->
		<jscomp compilationLevel="simple" warning="verbose" debug="false" output="${build.dir}/inverted-min.js">
			<sources dir="${build.dir}">
				<file name="inverted-min.js" />								
			</sources>
			<externs dir="${basedir}/ant">
			     <file name="node.js"/>
			</externs>
		</jscomp>
		
		<echo>Minifying Javascript... DONE</echo>
	</target>	
	
	<!-- Full Builds -->
	
	<target name="archive">
		<echo>Archiving... </echo>
		<property file="${version.file}" prefix="version" />
		<property name="version-string" value="${version.major}.${version.minor}.${version.build}" />
		
		<property name="versioned.dir" value="${archive.dir}/inverted-${version-string}" />		
		<mkdir dir="${versioned.dir}" />
		
		<copy todir="${versioned.dir}">
		   <fileset dir="${build.dir}" includes="inverted**.js, package.json"/>
		</copy>
		
		<replace file="${versioned.dir}/package.json" token="@version@" value="${version-string}" />
		<replace file="${versioned.dir}/inverted.js" token="@version@" value="${version-string}" />
		<replace file="${versioned.dir}/inverted-min.js" token="@version@" value="${version-string}" />
		
		<zip destfile="${versioned.dir}/inverted-${version-string}.zip">
			<zipfileset dir="${versioned.dir}" prefix="inverted-js"/>				
		</zip>
		
		<delete dir="${versioned.dir}/src"/>
		<delete dir="${versioned.dir}/test"/>				
		
		<copy file="${versioned.dir}/inverted.js" tofile="${latest.dir}/inverted.js"/>		 	
		<copy file="${versioned.dir}/inverted-min.js" tofile="${latest.dir}/inverted-min.js" />
		<copy file="${versioned.dir}/package.json" tofile="${latest.dir}/package.json" />
		
		<echo>Archiving... DONE</echo>
	</target>
	
	<target name="test-build" depends="minify-javascript" description="Perform a full build without updating version numbers">
	</target>
		
	<target name="daily-build" depends="minify-javascript" description="Perform a daily full build">
		<echo>Building daily...</echo>
		
		<propertyfile file="${version.file}">
			<entry key="build" value="+" operation="+" type="int" default="0" pattern="00" />
		</propertyfile>	
		
		<antcall target="archive" />
		
		<echo>Building daily... DONE</echo>
	</target>
	
	<target name="minor-build" depends="minify-javascript" description="Perform a minor full build">
		<echo>Building minor...</echo>
		
		<propertyfile file="${version.file}">
			<entry key="minor" value="+" operation="+" type="int" default="0" pattern="0" />
			<entry key="build" value="1" />
		</propertyfile>		
		
		<antcall target="archive" />

		<echo>Building minor... DONE</echo>
	</target>
	
	<target name="major-build" depends="minify-javascript" description="Perform a major full build">
		<echo>Building major...</echo>
		
		<propertyfile file="${version.file}">
			<entry key="major" value="+" operation="+" type="int" default="0" pattern="0" />
			<entry key="minor" value="1"  />
			<entry key="build" value="1" />
		</propertyfile>		
		
		<antcall target="archive" />
		
		
		<echo>Building major... DONE</echo>
	</target>
</project>

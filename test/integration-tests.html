<!DOCTYPE html>
<html>
<head>
<title>Inverted Tests</title>
<link type="text/css" rel="stylesheet" href="../support/qunit.css">

<script src="../support/qunit.js"></script>
<script src="../support/q2junit.js"></script>

<script src="../support/require.js"></script>
<!--<script src="../lib/curl.js"></script>-->

</head>
<body>
<script>

    var amdConfig = {
        baseUrl: "resources/amd",
        paths: {
            "jquery" : "https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min",
            "inverted/Promise" : "../../../src/inverted/Promise",
            "inverted/AppContext" : "../../../src/inverted/AppContext",
            "inverted/ProtoFactory": "../../../src/inverted/ProtoFactory"
            //"inverted" : "../../../lib/inverted-min"
        }
    };

    //figure out the amd loader
    if(window.requirejs) {
        requirejs.config(amdConfig);
    } else if(window.curl) {
        curl.config(amdConfig);
        window.require = window.curl;
    }

    require(["inverted/AppContext", "app-config"], function(AppContext, conf) {
    //require(["inverted", "app-config"], function(AppContext, conf) {

	var appContext = AppContext.create(conf);
    
    module("Integration Tests");

     asyncTest("simpleInstance", 1, function() {

    	appContext.getProto("a", function(a) {
    		require(["A"], function(A) {

    			assertInstanceOf(A, a);
                start();
    		});
    	});
    });

    asyncTest("simpleInstancePromiseSuccess", 2, function() {

        var promise = appContext.getProto("a", "b");
        promise.then(function(a, b) {
            require(["A", "B"], function(A, B) {

                assertInstanceOf(A, a);
                assertInstanceOf(B, b);
                start();
            });
        });
    });

    asyncTest("simpleInstancePromiseFail", 3, function() {

        var promise = appContext.getProto("a", "b", "z");
        promise.then(function(a, b) {
            require(["A", "B"], function(A, B) {

                assertInstanceOf(A, a);
                assertInstanceOf(B, b);
                start();
            });
        }, function(e) {
            assertTrue(true);
        });
    });

    asyncTest("simpleConstructorInjectLiterals", 4, function() {

		appContext.getProto("c", function(c) {

			assertSame(c.str, "String");
			assertSame(c.number, 99);
			assertSame(c.bool, true);
			assertNull(c.nully);

            start();
		});
	});

    asyncTest("simpleConstructorInjectDependency", 10, function() {

		appContext.getProto("a", "a2", function(a, a2) {
         	         	
         	require(["A", "B", "C"], function(A, B, C) {
    			
    			assertInstanceOf(A, a);    			
    			assertInstanceOf(A, a2);
    			
    			assertInstanceOf(B, a.b);    			
    			assertInstanceOf(B, a2.b);
    			
    			assertInstanceOf(C, a.b.c);    			
    			assertInstanceOf(C, a2.b.c);
    			
    			assertSame(a.b.c.str, "String");
    			assertSame(a.b.c.number, 99);
    			assertSame(a.b.c.bool, true);
    			assertNull(a.b.c.nully);

                start();
    		});
		});    	
    });

    asyncTest("simpleConstructorInjectObjectArgs", 5, function() {

        appContext.getProto("e", "c", function(e, c) {

            require(["E", "C"], function(E, C) {

                assertSame(e.str, "str");
                assertSame(e.number, 77);
                assertSame(e.bool, true);
                assertNull(e.nully);

                assertInstanceOf(C, e.obj);

                start();
            });
        });
    });

    asyncTest("simplePropertyInjectLiterals", 5, function() {

		appContext.getProto("d", function(d) {

			assertSame(d.str, "hi");
			assertSame(d.number, 88);
			assertSame(d.bool, false);
			assertNull(d.nully);
            assertSame(d.fromMethod, "set");

            start();
		});
	});

    asyncTest("simplePropertyInjectDependency", 7, function() {

		appContext.getProto("d", function(d) {
         	         	
         	require(["A", "B", "C", "D" ], function(A, B, C, D) {
    			
    			assertInstanceOf(D, d);    			    			
    			
    			assertInstanceOf(B, d.b);    			    			
    			
    			assertInstanceOf(C, d.b.c);    			    			
    			
    			assertSame(d.b.c.str, "String");
    			assertSame(d.b.c.number, 99);
    			assertSame(d.b.c.bool, true);
    			assertNull(d.b.c.nully);

                start();
    		});
		});    	
	});

    asyncTest("multiInstantiate", 3, function() {

		appContext.getProto("a", "b", "c", function(a, b, c) {
         	         	
         	require(["A", "B", "C"], function(A, B, C) {
    			
    			assertInstanceOf(A, a);
    			assertInstanceOf(B, b);
    			assertInstanceOf(C, c);

                start();
    		});
		});    	
	});

    asyncTest("scopes", 7, function() {

		appContext.getProto("d", "d2", "d3", function(d, d2, d3) {
			
			appContext.getProto("d", "d2", "d3", function(anotherD, anotherD2, anotherD3) {

				assertNotSame(d, anotherD);
				assertNotSame(d.b, anotherD.b);
				
				assertSame(d2, anotherD2);
				assertSame(d2.b, anotherD2.b);	

				require(["D"], function(D) {

					assertInstanceOf(D, d);
					assertInstanceOf(D, d2);
					assertSame(D, d3);
                    start();
				})
				
			});			
		});
		
	});

    asyncTest("inheritance", 5, function() {

		appContext.getProto("d4", function(d4) {
	
			require(["A", "D"], function(A, D) {

				assertInstanceOf(D, d4);
				assertInstanceOf(A, d4);							
				
				assertEquals(D, d4.constructor);
				
				assertEquals("Hello Geoff Capes", d4.hello());
				assertEquals("Bye!", d4.bye());

                start();
			});		
		});
				
	});

    asyncTest("factoryMethod", 1, function() {

		appContext.getProto("c2", function(c2) {
			
			assertEquals(c2.number, 12345);
            start();
		});
	});

    asyncTest("utilsInject", 1, function() {

        appContext.getProto("b3", function(b3) {

            assertTrue(b3.useUtil());

            start();
        })
	});

    asyncTest("jquery", 2, function() {
        appContext.getProto("f", function(f) {

            assertTrue(f.isNumber(999));
            assertFalse(f.isNumber("NaN"));

            start();
        });
    });
/*
    asyncTest("circular", 2, function() {
        appContext.getProto("circular1", function(circular1) {

            assertTrue(circular1);
            assertTrue(circular1.a);

            start();
        });
    });
*/



    });
</script>
<h1 id="qunit-header">AppContext test</h1>
 <h2 id="qunit-banner"></h2>
 <div id="qunit-testrunner-toolbar"></div>
 <h2 id="qunit-userAgent"></h2>
 <ol id="qunit-tests"></ol>
 <div id="qunit-fixture"></div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
<title>AppContext Test</title>

<script src="http://yui.yahooapis.com/combo?3.3.0/build/yui/yui-min.js"></script>

<script> window.DEBUG = true; </script>
<script src="../../main/inverted/release/init.js"></script>
<script src="../../main/inverted/Namespace.js"></script>
<script src="../../main/inverted/Util.js"></script>
<script src="../../main/inverted/resolvers/resolvers.js"></script>
<script src="../../main/inverted/AppContext.js"></script>

</head>
<body>
<script>
    YUI().use("test", function(Y){    	
        
        var testCase = new Y.Test.Case({
            name : "AppContext Test",
			            
            testGetProto : function() {        
            	
            	 var conf =  {
        	        srcBase: "/js",
        	        srcResolver: inverted.resolvers.defaultSrcResolver,
        	        protos: {
        	        	proto1 : {
        	        		proto: "test.Proto1",
        	        		args: [
        	        			"*proto2",
        	        			{
        	        				ref: "proto3"
        	        			}
        	        		],
        	        		props: {
        	        			prop1: "*proto4"
        	        		}        	        
        	        	},
        	        	proto2: {
        	        		proto: "test.Proto2",
        	        		props: {
        	        		    prop1: "*proto5"
        	        		}   	        	
        	        	},
        	        	proto3: {
        	        		proto: "test.Proto3",
        	        		args: [
        	        		    "*proto5"
        	        		]        	        		
        	        	},
        	        	proto4: {
        	        		proto: "test.Proto4",        	        		   	        		        	        
        	        	},
        	        	proto5: {
        	        		proto: "test.Proto5",        	        		     	
        	        	},
        	        	proto6 : {
        	        		proto: "test.Proto6"
        	        	},
        	        	proto7 : {
        	        		proto: "test.Proto7"
        	        	}
        	        }
        	    };
            	//proto1, proto2, proto5, proto3, proto4 
            	 var mockProtoFactory = {};
            	 mockProtoFactory.getProto = function(id) {
                 		
             		function proto(id) {
             			this.id = id
             		};
             		return new proto(id);
               	 };
                 mockProtoFactory.getProtoConfig = function(id) {
             		return conf.protos[id];
             	 };              
             	 mockProtoFactory.parseProtoString = function(protoString) {
            		return inverted.util.parseProtoString(protoString, window);
            	 };

                var mockRequire = {}
                mockRequire.load = function(scripts, callback, ctx) {
                	
                	var expected = 
                		[ "/js/test/Proto1.js","/js/test/Proto2.js","/js/test/Proto5.js","/js/test/Proto3.js","/js/test/Proto4.js", "/js/test/Proto7.js"];
                	
                	for( var i = 0; i < expected.length; i++) {
						Y.Assert.areEqual(expected[i], scripts[i]);
					}                	                	
                	
                	callback.apply(ctx, [true, [], ""]);                	
                };
         
                var appContext = new inverted.AppContext(conf, "myEnv", null, mockProtoFactory, mockRequire);
                
                Y.Assert.areEqual("myEnv", appContext.profile);
                appContext.getProto("proto1", "proto7", function(proto1, proto7) {
                	Y.Assert.areEqual("proto1", proto1.id);
                	Y.Assert.areEqual("proto7", proto7.id);
                });                               
            },
            
            testEnvironments : function() {        
            	
            	var prodSrcResolver = function(toGet, base)
            	{
            		return base + "/prod.js"
            	};
            	
            	var devSrcResolver = function(toGet, base)
            	{
            		return base + "/dev.js"
            	};
            	
           	 	var conf =  {
           	        srcBase: {
           	        	prod: "/js",
           	        	dev: "/js/src"
           	        },
           	        srcResolver: {
           	        	prod: prodSrcResolver,
           	        	dev: devSrcResolver
           	        },
           	        protos: {
           	        	proto1 : {
           	        		proto: "test.Proto1",       	        		        	       
           	        	}       	        	
           	        }
           	    };
           	 	           	 	           	 
               	var mockProtoFactory = {};
               	mockProtoFactory.getProto = function(id) {
                    		
            		function proto(id) {
            			this.id = id
            		};
            		return new proto(id);
              	};
                mockProtoFactory.getProtoConfig = function(id)
            	{
            		return conf.protos[id];
            	};
            	mockProtoFactory.parseProtoString = function(protoString) {
            		return inverted.util.parseProtoString(protoString, window);
            	};

            	var expected = [];
                var mockRequire = {};
                mockRequire.load = function(scripts, callback, ctx) {               	
               	
					for( var i = 0; i < expected.length; i++) {
						Y.Assert.areEqual(expected[i], scripts[i]);
					}                	                	
               	
               		callback.apply(ctx, [true, [], ""]);                	
                };
        
                var prodAppContext = new inverted.AppContext(conf, "prod", null, mockProtoFactory, mockRequire);                               
                expected = [ "/js/prod.js"];
                prodAppContext.getProto("proto1");
                
                var devAppContext = new inverted.AppContext(conf, "dev", null, mockProtoFactory, mockRequire);                               
                expected = [ "/js/src/dev.js"];
                devAppContext.getProto("proto1");
           }                        

        });

        Y.Test.Runner.add(testCase);

        var TestRunner = Y.Test.Runner;
        TestRunner.run();

    });
</script>
</body>
</html>
